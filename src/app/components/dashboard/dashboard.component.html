<div class="dashboard-container">
  <div class="content-wrapper">

    <div class="header-card">
      <div class="header-text">
        <h1>Dashboard Comercial {{ anioActual }}</h1>
        <p>Gestión de desempeño mensual y metas</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header-flex">
        <h3 class="card-title">Comparativo de Rendimiento</h3>
        <div class="chart-controls">
          <button class="btn btn-sm"
                  [ngClass]="filtrosGrafico.metricas === 'monto' ? 'btn-primary' : 'btn-outline'"
                  (click)="toggleMetrica()">
            Ver Montos (S/.)
          </button>
          <button class="btn btn-sm"
                  [ngClass]="filtrosGrafico.metricas === 'unidades' ? 'btn-primary' : 'btn-outline'"
                  (click)="toggleMetrica()">
            Ver Unidades
          </button>
        </div>
      </div>

      <div class="brands-filter">
        <label *ngFor="let m of marcas" class="checkbox-pill">
          <input type="checkbox"
                 [checked]="filtrosGrafico.marcasSeleccionadas.includes(m.id)"
                 (change)="toggleMarcaFiltro(m.id)">
          {{ m.nombre }}
        </label>
      </div>

      <div class="chart-container">
        <div id="containerG2" style="height: 400px; width: 100%;"></div>
      </div>
    </div>

    <div class="card table-card">
      <div class="card-header-flex">
        <h3 class="card-title">Editor de Desempeño Mensual</h3>

        <div class="brand-selector">
          <label>Seleccionar Marca a Editar:</label>
          <select [(ngModel)]="marcaSeleccionadaId" (change)="onMarcaTablaChange()" class="form-control-lg">
            <option value="" disabled>-- Elige una marca --</option>
            <option *ngFor="let m of marcas" [value]="m.id">{{ m.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="table-responsive" *ngIf="marcaSeleccionadaId">
        <table class="matrix-table">
          <thead>
          <tr>
            <th class="sticky-col">Indicador</th>
            <th *ngFor="let mes of datosTabla">{{ mes.mesNombre }}</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td class="sticky-col label-row">Venta Real (S/.)</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell"
                     [(ngModel)]="fila.ventaReal"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr>
            <td class="sticky-col label-row">Unidades</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell"
                     [(ngModel)]="fila.unidades"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr>
            <td class="sticky-col label-row">Meta (S/.)</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell meta-input"
                     [(ngModel)]="fila.meta"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr class="calc-row">
            <td class="sticky-col label-row">Variación %</td>
            <td *ngFor="let fila of datosTabla"
                [ngClass]="{'text-green': fila.variacion >= 0, 'text-red': fila.variacion < 0}">
              {{ fila.variacion | number:'1.0-1' }}%
            </td>
          </tr>
          <tr class="calc-row">
            <td class="sticky-col label-row">Score</td>
            <td *ngFor="let fila of datosTabla">
                  <span class="score-badge"
                        [ngClass]="{'score-high': fila.score >= 100, 'score-mid': fila.score >= 80 && fila.score < 100, 'score-low': fila.score < 80}">
                      {{ fila.score | number:'1.0-0' }}%
                  </span>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="save-actions">
          <p *ngIf="cambiosSinGuardar" class="unsaved-warning">⚠ Tienes cambios sin guardar</p>
          <button class="btn btn-primary btn-lg" (click)="guardarCambiosTabla()">
            Guardar Cambios
          </button>
        </div>
      </div>

      <div *ngIf="!marcaSeleccionadaId" class="empty-state">
        <p>Selecciona una marca arriba para ver y editar su tabla de desempeño.</p>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">Historial de Cambios</h3>
      <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
        <table class="data-table">
          <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Marca</th>
            <th>Mes Afectado</th>
            <th>Campo Modificado</th>
            <th>Valor Anterior</th>
            <th>Valor Nuevo</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let log of historial">
            <td class="text-muted text-sm">{{ log.fecha | date:'dd/MM/yy HH:mm' }}</td>
            <td><strong>{{ log.marca }}</strong></td>
            <td>{{ meses[log.mesAfectado - 1] }}</td>
            <td>{{ log.campo }}</td>
            <td class="text-red">{{ log.valorAnterior | number }}</td>
            <td class="text-green">{{ log.valorNuevo | number }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
