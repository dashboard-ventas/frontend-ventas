<div class="dashboard-container">
  <div class="content-wrapper">

    <div class="header-card">
      <div class="header-text">
        <h1>Dashboard Comercial {{ anioActual }}</h1>
        <p>Gestión de desempeño mensual y metas</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header-flex">
        <h3 class="card-title">Comparativo de Rendimiento</h3>

        <div class="chart-controls-group">
          <div class="btn-group">
            <button class="btn btn-sm"
                    [ngClass]="filtrosGrafico.metricas === 'monto' ? 'btn-primary' : 'btn-outline'"
                    (click)="toggleMetrica()">
              S/.
            </button>
            <button class="btn btn-sm"
                    [ngClass]="filtrosGrafico.metricas === 'unidades' ? 'btn-primary' : 'btn-outline'"
                    (click)="toggleMetrica()">
              Und.
            </button>
          </div>

          <div class="btn-group ml-2">
            <button class="btn btn-sm"
                    [ngClass]="filtrosGrafico.tipoGrafico === 'line' ? 'btn-dark' : 'btn-outline'"
                    (click)="toggleTipoGrafico('line')"
                    title="Ver Tendencia">
              Línea
            </button>
            <button class="btn btn-sm"
                    [ngClass]="filtrosGrafico.tipoGrafico === 'column' ? 'btn-dark' : 'btn-outline'"
                    (click)="toggleTipoGrafico('column')"
                    title="Comparar Meses">
              Barras
            </button>
          </div>
        </div>
      </div>

      <div class="filters-section">
        <div class="filter-row">
          <span class="filter-label">Marcas:</span>
          <div class="pills-container">
            <label *ngFor="let m of marcas" class="checkbox-pill">
              <input type="checkbox"
                     [checked]="filtrosGrafico.marcasSeleccionadas.includes(m.id)"
                     (change)="toggleMarcaFiltro(m.id)">
              {{ m.nombre }}
            </label>
          </div>
        </div>

        <div class="filter-row mt-2">
          <div class="flex-label">
            <span class="filter-label">Meses:</span>
            <button class="text-xs-btn" (click)="toggleTodosMeses(true)">Todos</button>
            <button class="text-xs-btn" (click)="toggleTodosMeses(false)">Ninguno</button>
          </div>

          <div class="pills-container">
            <label *ngFor="let mes of meses; let i = index"
                   class="checkbox-pill checkbox-pill-sm"
                   [ngClass]="{'active': filtrosGrafico.mesesSeleccionados.includes(i + 1)}">
              <input type="checkbox"
                     [checked]="filtrosGrafico.mesesSeleccionados.includes(i + 1)"
                     (change)="toggleMesFiltro(i)">
              {{ mes }}
            </label>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div id="containerG2" style="height: 400px; width: 100%;"></div>
      </div>
    </div>

    <div class="card table-card">
      <div class="card-header-flex">
        <h3 class="card-title">Editor de Desempeño Mensual</h3>

        <div class="brand-selector">
          <label>Seleccionar Marca a Editar:</label>
          <select [(ngModel)]="marcaSeleccionadaId" (change)="onMarcaTablaChange()" class="form-control-lg">
            <option value="" disabled>-- Elige una marca --</option>
            <option *ngFor="let m of marcas" [value]="m.id">{{ m.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="table-responsive" *ngIf="marcaSeleccionadaId">
        <table class="matrix-table">
          <thead>
          <tr>
            <th class="sticky-col">Indicador</th>
            <th *ngFor="let mes of datosTabla">{{ mes.mesNombre }}</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td class="sticky-col label-row">Venta Real (S/.)</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell"
                     [(ngModel)]="fila.ventaReal"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr>
            <td class="sticky-col label-row">Unidades</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell"
                     [(ngModel)]="fila.unidades"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr>
            <td class="sticky-col label-row">Meta (S/.)</td>
            <td *ngFor="let fila of datosTabla">
              <input type="number" class="input-cell meta-input"
                     [(ngModel)]="fila.meta"
                     (change)="onCeldaChange(fila)"
                     min="0">
            </td>
          </tr>
          <tr class="calc-row">
            <td class="sticky-col label-row">Variación %</td>
            <td *ngFor="let fila of datosTabla"
                [ngClass]="{'text-green': fila.variacion >= 0, 'text-red': fila.variacion < 0}">
              {{ fila.variacion | number:'1.0-1' }}%
            </td>
          </tr>
          <tr class="calc-row">
            <td class="sticky-col label-row">Score</td>
            <td *ngFor="let fila of datosTabla">
                  <span class="score-badge"
                        [ngClass]="{'score-high': fila.score >= 100, 'score-mid': fila.score >= 80 && fila.score < 100, 'score-low': fila.score < 80}">
                      {{ fila.score | number:'1.0-0' }}%
                  </span>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="save-actions">
          <p *ngIf="cambiosSinGuardar" class="unsaved-warning">⚠ Tienes cambios sin guardar</p>
          <button class="btn btn-primary btn-lg"
                  (click)="guardarCambiosTabla()"
                  [disabled]="!cambiosSinGuardar">
            Guardar Cambios
          </button>
        </div>
      </div>

      <div *ngIf="!marcaSeleccionadaId" class="empty-state">
        <p>Selecciona una marca arriba para ver y editar su tabla de desempeño.</p>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">Historial de Cambios</h3>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Marca</th>
            <th>Mes Afectado</th>
            <th>Campo Modificado</th>
            <th>Valor Anterior</th>
            <th>Valor Nuevo</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let log of historialPaginado">
            <td class="text-muted text-sm">{{ log.fecha | date:'dd/MM/yy HH:mm' }}</td>
            <td><strong>{{ log.marca }}</strong></td>
            <td>{{ meses[log.mesAfectado - 1] }}</td>
            <td>{{ log.campo }}</td>
            <td class="text-red">{{ log.valorAnterior | number }}</td>
            <td class="text-green">{{ log.valorNuevo | number }}</td>
          </tr>
          <tr *ngIf="historial.length === 0">
            <td colspan="6" class="text-center py-4 text-muted">No hay historial registrado</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-controls" *ngIf="historial.length > 0">
        <button class="btn btn-sm btn-outline"
                (click)="cambiarPagina(-1)"
                [disabled]="paginaActual === 1">
          &laquo; Anterior
        </button>

        <span class="page-info">
          Página <strong>{{ paginaActual }}</strong> de <strong>{{ totalPaginas }}</strong>
        </span>

        <button class="btn btn-sm btn-outline"
                (click)="cambiarPagina(1)"
                [disabled]="paginaActual === totalPaginas">
          Siguiente &raquo;
        </button>
      </div>
    </div>

  </div>
</div>
